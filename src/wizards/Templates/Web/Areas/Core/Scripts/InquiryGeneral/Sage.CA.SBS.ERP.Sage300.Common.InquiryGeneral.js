(function(){var n=window.kendo,t=n.ui,i=t.Widget,r=i.extend({dataSource:null,options:{name:"GridFilterPanel",template:"<span style='color:blue'>Filter:<\/span> #= filter #",placeholder:"<span style='color:blue'>No Filter<\/span>",columns:[]},init:function(n,t){i.fn.init.call(this,n,t);this.element.attr("class","k-block k-header");this.element.attr("style","min-height:1.5em;");typeof this.options.dataSource!="undefined"&&this.setDataSource(this.options.dataSource);this.element.append("<span class='k-message' style='display:inline-block; margin:0.4em;'><\/span>");this.displayFilter()},operatorText:function(n){var t=n.operator?n.operator:n.Operator;switch(t){case"eq":t="=";break;case"neq":t="!=";break;case"gte":t=">=";break;case"gt":t=">";break;case"lte":t="<=";break;case"lt":t="<"}return t},getDisplayFilter:function(t){var f="",s=t.filters,h,c,e,i,u,o,r,a,v,l;if(s==null)return f;for(h=s.length,c=["int32","int64","int16","long","byte","real","decimal"],e=0;e<h;e++){if(i=s[e],i.filters!=null&&i.filters.length>0)f+=n.format("({0})",this.getDisplayFilter(i));else{if(u=this.options.columns.filter(function(n){return n.columnName===i.field})[0],!u)continue;o=u.dataType.toLowerCase();r=o==="datetime"?n.toString(n.parseDate(i.value),"d"):i.value;r=r.replace(/'/g,"");u.presentation&&(r=u.presentation.filter(function(n){return n.Value==r})[0].Text);a=c.indexOf(o)>-1?"{0} {1} {2}":"{0} {1} '{2}'";c.indexOf(o)>-1&&(r=n.toString(n.parseFloat(r),"n"+u.presion));v=u.title;f+=n.format(a,v,this.operatorText(i),r)}e<h-1&&(l=t.logic.toLowerCase(),f+=n.format(l=="and"||l=="or"?" <span>{0}<\/span> ":" {0} ",t.logic))}return f},displayFilter:function(){var t="",i,r;this.dataSource!==null&&this.dataSource._filter&&(i=this.dataSource._filter,t=this.getDisplayFilter(i));r=t?n.template(this.options.template)({filter:t}):this.options.placeholder;this.element.find(".k-message").html(r)},setDataSource:function(n){var t=this,i=function(n){t.displayFilter.call(t,n)};this.dataSource!==null&&this.dataSource.unbind("change",i);this.dataSource=n;this.dataSource.bind("change",i);this.displayFilter()}});t.plugin(r)})(jQuery);var InquiryGeneralUI=function(){function k(){function t(n){var r,u;if(n.TemplateId=InquiryGeneralViewModel.TemplateId,n.TemplateId===n.winTemplateId){var t=$("#inquiryGrid").data("kendoGrid"),f=t.getOptions().columns,e=f.map(function(n){return n.IsDisplayable=!n.hidden,n}),o=t.getOptions().dataSource.filter,s=t.getOptions().dataSource.group;i=n.Name;n.Type==inquiryGeneralResources.Private?n.Type="Private":n.Type==inquiryGeneralResources.Public&&(n.Type="Public");r={template:n,fields:e,filter:o,group:s};u=sg.utls.url.buildUrl("Core","InquiryGeneral","SaveTemplate");sg.utls.ajaxPost(u,r,nt)}}var n=InquiryGeneralViewModel.UserMessage;if(n&&n.Errors&&n.Errors.length>0){sg.utls.showMessage(InquiryGeneralViewModel);return}d(InquiryGeneralViewModel);g();ot();et(null);window.parent.addEventListener("message",function(n){n.data.event_id==="SaveQueryPanel"&&t(n.data.template)})}function d(n){n.IsAdhocQuery&&($("#divShowGrandTotals").show(),$("#headerButtonsId").show())}function g(){var n=InquiryGeneralViewModel.Title;$("#InquiryGeneralHeader").text(inquiryGeneralResources.Inquiry+" - "+n)}function nt(n){n&&(n.Errors?sg.utls.showMessage(n):(InquiryGeneralViewModel.TemplateId=n.TemplateId,InquiryGeneralViewModel.Title=i,InquiryGeneralViewModel.Name=InquiryGeneralViewModel.Title,$("#InquiryGeneralHeader").text("Inquiry - "+i),$("#btnDeleteQuery").prop("disabled",!1),window.parent.postMessage({event_id:"SaveTemplate",inquiryTitle:"Inquiry - "+i},"*")))}function tt(n){n.Errors?sg.utls.showMessage(n):($("#btnDeleteQuery").prop("disabled",!0),$("#btnSaveQuery").prop("disabled",!0),window.parent.postMessage({event_id:"DeleteTemplate"},"*"))}function v(){for(var n,f,g,o,u,k=InquiryGeneralViewModel.Fields,nt=k.length,d=[],s=["int32","int64","int16","integer","long","byte","real","decimal"],l=InquiryGeneralViewModel.IsAdhocQuery,v=0;v<nt;v++)if(n=k[v],n.Included){var t={},i=n.DataType.toLowerCase(),tt=l&&n.IsGroupable?"groupable":"",p=s.indexOf(i)>-1?"align-right ":"align-left ",w=s.indexOf(i)>-1?"number":i,r=n.PresentationList;if(w=r&&r.length>0?"enum":w,p+=tt,l&&!a&&n.IsDisplayable&&(a=!0,t.locked=!0,y(t,"footer"),y(t,"group")),t.lockable=!1,t.title=n.Title,t.field=n.FieldAlias||n.Field,t.isDummy=n.IsDummy,t.dataType=n.DataType,t.presion=n.Precision,t.isFilterable=n.IsFilterable,t.columnName=n.FieldAlias||n.Field,t.presentation=r&&r.length==0?null:r,t.width=n.IsDummy?100:160,t.headerWidth=n.IsDummy?100:160,t.attributes={"class":p},t.headerAttributes={"class":p,dataType:w},t.template=ft(n),t.isDrillDown=n.IsDrilldown,t.drillDownUrl=n.DrilldownUrl,t.hidden=n.IsDisplayable===undefined?!1:!n.IsDisplayable,t.groupable=n.IsGroupable,t.isAggregate=n.IsAggregate,i==="string"?t.filterable={operators:{string:b}}:i==="datetime"?t.filterable={ui:"datepicker"}:s.indexOf(i)>-1?t.filterable={ui:$.proxy(it,{field:n})}:r&&r.length>0&&(h[n.Field]=r,t.filterable={ui:$.proxy(rt,{field:n.Field}),operators:{string:{eq:"=",neq:"!="}}}),l){if(f=["sum","min","max","avg","count"],i==="decimal"&&n.IsAggregate&&(f.forEach(function(n){c.push({field:t.field,aggregate:n})}),e.indexOf(t.field)<0&&e.push(t.field)),t.aggregates=n.Aggregates,n.IsAggregate&&n.Aggregates&&n.Aggregates.length>0){for(g=n.Aggregates.map(function(n){return n.toLowerCase()}),o="",u=0;u<5;u++)g.indexOf(f[u])>-1&&(o+=kendo.format("<div>#=kendo.toString({0},'n{1}')#<\/div>",f[u],u===4?0:3));t.groupFooterTemplate=o}i==="decimal"&n.IsAggregate&&(t.footerTemplate=o)}d.push(t)}return d}function y(n,t){var i=kendo.format("<span id=footer{0} ><div>{1}:<\/div>",n.field,t=="footer"?inquiryGeneralResources.GrandTotal:inquiryGeneralResources.Total);i+=kendo.format("<div>{0}:<\/div>",inquiryGeneralResources.Minimum);i+=kendo.format("<div>{0}:<\/div>",inquiryGeneralResources.Maximum);i+=kendo.format("<div>{0}:<\/div>",inquiryGeneralResources.Average);i+=kendo.format("<div>{0}:<\/div><\/span>",inquiryGeneralResources.Count);t=="footer"?n.footerTemplate=i:n.groupFooterTemplate=i}function it(n){n.kendoNumericTextBox({format:"n"+this.field.Precision,spinners:!1,decimals:this.field.Precision})}function rt(n){n.kendoDropDownList({dataTextField:"Text",dataValueField:"Value",dataSource:h[this.field]})}function ut(n){var t=n.operator?n.operator:n.Operator;switch(t){case"eq":t="=";break;case"neq":t="!=";break;case"gte":t=">=";break;case"gt":t=">";break;case"lte":t="<=";break;case"lt":t="<";break;case"Like":case"StartsWith":case"Contains":t="LIKE"}return t}function o(t){var f="",y,l,r,d,a,h,g,i,p,u,e,c,s,nt,b,w,tt;if(!t||(y=t.filters,y==null))return f;var k=y.length,it=["Int32","Int64","Int16","Long","Byte","Real","Decimal"],rt=["like","startswith","contains","endwith"];for(l=0;l<k;l++){if(r=y[l],r.filters!=null&&r.filters.length>0)f+=kendo.format("({0})",o(r));else{if(d=n===undefined?v():n.columns,a=d.filter(function(n){return n.columnName==r.field})[0],!a)continue;h=r.field;g=a.dataType.toLowerCase();g==="datetime"?(p=kendo.parseDate(new Date(r.value)),i=kendo.toString(p,"yyyyMMdd"),r.value=kendo.toString(p,"d")):i=r.value;u="";e=(r.operator?r.operator:r.Operator).toLowerCase();rt.indexOf(e)>-1?(c="",s="",u=InquiryGeneralViewModel.Sql,i=u?i.toUpperCase():i,e==="like"&&(s=u?"upper({0}) LIKE '%{1}%'":"{0} LIKE %{1}%",nt=u?"upper({0}) LIKE '{1}'":"{0} LIKE {1}",c=i.indexOf("%")>-1?kendo.format(nt,h,i):kendo.format(s,h,i)),e==="contains"&&(s=u?"upper({0}) LIKE '%{1}%'":"{0} LIKE %{1}%",c=kendo.format(s,h,i)),e==="startswith"&&(s=u?"upper({0}) LIKE '{1}%'":"{0} LIKE {1}%",c=kendo.format(s,h,i)),e==="endwith"&&(s=u?"upper({0}) LIKE '%{1}'":"{0} LIKE %{1}",c=kendo.format(s,h,i)),f+=c):(u=InquiryGeneralViewModel.Sql,w="",b=a.dataType.toLowerCase()=="string"&&e=="eq",i=b&&u?i.toUpperCase():i,w=it.indexOf(a.dataType)>-1?"{0} {1} {2}":u?b?"upper({0}) {1} '{2}'":"{0} {1} '{2}'":'{0} {1} "{2}"',e=ut(r),f+=kendo.format(w,h,e,i))}l<k-1&&(f+=kendo.format(" {0} ",t.logic?t.logic:t.Logic))}return tt=f.split(" or ").length==2&&f.indexOf("(")===-1,tt?"("+f+")":f}function ft(n){var t,i=n.DataType.toLowerCase();return i==="decimal"&&(t="#= kendo.toString("+n.Field+', "n'+n.Precision+'") #'),n.IsDrilldown&&(t=kendo.format("<a href=''>#={0}#<\/a>",n.FieldAlias||n.Field)),i==="datetime"&&(t=kendo.format(w,n.FieldAlias||n.Field)),n.IsDummy&&(t='<img src="../../../../Content/Images/nav/drilldown.png" height="16" width="16"  style="float:middle">'),t}function et(){function w(n){var t,r;if(n==null||n.length==0)return{};var u={},f=InquiryGeneralViewModel.Aggregates,e=f.length;for(i=0;i<e;i++)t={},r=5*i,t.sum=n[r++],t.avg=n[r++],t.max=n[r++],t.min=n[r++],t.count=n[r++],u[f[i]]=t;return u}function b(n){for(var i,e,o=[],l=n.length,u=0;u<l;u++){var s=n[u],a=s.length,h={};for(i=0;i<a;i++){var c=r[i].presentation,v=r[i].field,f=r[i].dataType.toLowerCase(),t=s[i];t&&(f==="datetime"||f==="date"||f==="time")&&(t=t.toString().length===8?kendo.parseDate(t.toString(),"yyyyMMdd"):t);c&&(e=c.filter(function(n){return n.Value==t}),e.length>0&&(t=e[0].Text));h[v]=t}o.push(h)}return o}function k(n){var t,i,f,e,r,s;if(n==null)return{};var o={},u=InquiryGeneralViewModel.Fields,h=1,c=u.length;for(t=0;t<c;t++)if(i=u[t].Aggregates,f=i.length,i!=null&&f>0){for(e={},r=0;r<f;r++)s=i[r],e[s]=n[h++];o[u[t].Field]=e}return o}function d(t,i){var r,s,u,h,e,c;if(t==null||t.length==0||i.length==0)return[];var o=[],f=InquiryGeneralViewModel.Groups[0].field,l=i.map(function(n){return n[f]}),a=l.filter(function(n,t,i){return i.indexOf(n)===t});for(r=0,s=t.length;r<s;r++)u=a[r],h=n.columns.filter(function(n){return n.field==f})[0].dataType,h.toLowerCase()=="datetime"&&(u=kendo.toString(kendo.parseDate(u),"d")),e={hasSubgroups:!1,field:f,value:u},c=k(t[r]),e.aggregates=c,e.items=i.filter(function(n){return n[f]==u}),o.push(e);return o}function a(n){return n&&(n.filters&&n.filters.length>0&&n.filters.forEach(function(n){a(n)}),n.Operator&&(n.operator=n.Operator=="="?"eq":n.Operator,delete n.Operator)),n}var u=new kendo.data.DataSource({serverPaging:!0,serverFiltering:!0,serverSorting:InquiryGeneralViewModel.Sql.length>0,serverAggregates:!0,serverGrouping:!0,aggregate:c,pageSize:t,filter:a(InquiryGeneralViewModel.Filter),transport:{read:function(i){var s=i.data.filter,r=o(s),u,f;InquiryGeneralViewModel.FilterString=r.length>3?r:"";InquiryGeneralViewModel.Sorts=i.data.sort;InquiryGeneralViewModel.Aggregates=e;n&&n.dataSource&&(InquiryGeneralViewModel.Groups=n.dataSource.group());u={currentPageNumber:n?n.dataSource.page()-1:0,pageSize:t,viewModel:InquiryGeneralViewModel};f=sg.utls.url.buildUrl("Core","InquiryGeneral","Get");sg.utls.ajaxPost(f,u,function(n){var t=b(n.Items),u=w(n.Aggregates),f=d(n.Groups,t),r;i.success({data:t,aggregates:u,groups:f,totalRecCount:n.TotalResultsCount});r=$("#chkShowGrandTotals").is(":checked");r?$("#inquiryGrid .k-grid-footer").show():$("#inquiryGrid .k-grid-footer").hide()})}},schema:{aggregates:"aggregates",total:"totalRecCount",data:"data",groups:"groups"}}),r=v(),f=InquiryGeneralViewModel.IsAdhocQuery,i,h,y;for(InquiryGeneralViewModel.Groups&&InquiryGeneralViewModel.Groups.length>0&&u.group(InquiryGeneralViewModel.Groups[0]),n=$("#inquiryGrid").kendoGrid({dataSource:u,columns:r,height:f?590:400,editable:!1,navigatable:!0,selectable:"row",scrollable:!0,resizable:!0,sortable:!0,reorderable:!f,columnMenu:!0,groupable:f,group:function(n){n.groups.length!=0&&(n.groups.length>1&&(n.groups[0].field==l?n.groups.shift():n.groups.pop()),l=n.groups.field||n.groups[0].field)},filterable:{extra:!0,operators:{string:s}},sortable:{allowUnsort:!1},columnShow:function(){},columnHide:function(){},pageable:{input:!0,numeric:!1,refresh:!0,change:function(){}},dataBound:function(n){for(var u,i,f,c,o,v,s,t,l,e,h=n.sender.columns,r=0,a=h.length;r<a;r++)if(u=h[r],u.isDrillDown&&(i=u.drillDownUrl&&u.drillDownUrl.DrilldownCondition,i&&i.Field))for(f=n.sender.dataSource.view(),t=0,c=f.length;t<c;t++)f[t][i.Field]!==i.Value&&(e=n.sender.tbody.find("[data-uid='"+f[t].uid+"']"),o=e.find("td:eq("+r+")"),o&&(o[0].innerHTML=o[0].innerText));for(v=this.wrapper.find(".k-grid-header [data-field=UnitsInStock]").index(),s=n.sender.dataSource.view(),t=0;t<s.length;t++)l=s[t].get("Discontinued"),e=n.sender.tbody.find("[data-uid='"+s[t].uid+"']"),l&&e.addClass("discontinued")}}).data("kendoGrid"),i=0;i<r.length;i++)h=r[i],h.isFilterable||(y=kendo.format("[data-field={0}]>.k-header-column-menu",h.field),n.thead.find(y).remove());$("#inquiryGrid").delegate("tbody > tr > td > a","click",p);$("#inquiryGrid").delegate("tbody > tr > td > img","click",p);$("#filter").kendoGridFilterPanel({dataSource:u,columns:n.options.columns}).data("kendoGridFilterPanel")}function ot(){function i(t){var et=sg.utls.url.buildUrl("Core","InquiryGeneral","Export"),v=InquiryGeneralViewModel.OrderByClause,c=InquiryGeneralViewModel.Sql,ot=n.columns,g=ot.filter(function(n){return!n.hidden}),st=g.map(function(n){return n.title}).join(","),y=g.map(function(n){return n.field}),nt=!1,i=InquiryGeneralViewModel.SelectClause.split(","),s,it,b,r,rt,k,h,l,e,a,d,ut,ft;i&&i.length>0&&(nt=i[0].indexOf(".")>0);var p=nt?i.map(function(n){return(n.indexOf(".")>-1?n.split(".")[1]:n).replace("[","").replace("]","")}):i,w=v?v.split(","):[],tt="",u=0,f="";for(s=0;s<y.length;s++){if(f=y[s],u=p.indexOf(f),u==-1)for(r=0,it=i.length;r<it;r++)if(i[r].indexOf(f)>-1){u=r;break}tt+=s<y.length-1?i[u]+",":i[u]}for(b=v?" order by ":"",r=0;r<w.length;r++)f=w[r].split(" "),u=p.indexOf(f[0]),rt=r===w.length-1?"{0} {1}":"{0} {1},",b+=kendo.format(rt,i[u],f[1]);if(k="",h=n.dataSource?n.dataSource.filter():null,h&&h.filters.length>0){for(l=o(h),e=h.filters.map(function(n){return n.field?n.field:n.filters&&n.filters.length>0?n.filters[0].field:void 0}),e=e.filter(function(n,t){return e.indexOf(n)==t}),a=0;a<e.length;a++)d=e[a],u=p.indexOf(d),ut=new RegExp(d,"g"),ft=i[u],l=l.replace(ut,ft);k=(c.toLowerCase().indexOf(" where ")<0?" where ":" and ")+l}c=c.replace("SELECTSTR",tt)+k+b;t.href=et+"/?sql="+c+"&titleStr="+st+"&name="+InquiryGeneralViewModel.Title}$("#btnPageSize10").click(function(){t=10;r.addClass("active");u.removeClass("active");f.removeClass("active");n.dataSource.pageSize(t)});$("#btnPageSize20").click(function(){t=50;u.addClass("active");r.removeClass("active");f.removeClass("active");n.dataSource.pageSize(t)});$("#btnPageSize30").click(function(){t=100;f.addClass("active");r.removeClass("active");u.removeClass("active");n.dataSource.pageSize(t)});$("#btnClearFilters").click(function(){n.dataSource.filter({})});$("#chkShowGrandTotals").click(function(){$("#inquiryGrid .k-grid-footer").toggle(this.checked)});$("#btnSaveQuery").click(function(){window.parent.postMessage({event_id:"SaveQuery",templateId:InquiryGeneralViewModel.TemplateId},"*")});$("#btnOpenQuery").click(function(){window.parent.postMessage({event_id:"OpenQuery"},"*")});$("#btnExportQuery").click(function(){var n=sg.utls.url.buildUrl("Core","InquiryGeneral","Export");sg.utls.ajaxPost(n,{sql:""},null)});$("#btnDeleteQuery").click(function(){var n=InquiryGeneralViewModel.TemplateId,t=jQuery.validator.format(inquiryGeneralResources.DeleteMessage,InquiryGeneralViewModel.Title);sg.utls.showKendoConfirmationDialog(function(){var t=sg.utls.url.buildUrl("Core","InquiryGeneral","DeleteTemplate");sg.utls.ajaxPost(t,{templateId:n},tt)},null,t,"")});$("#btnDeleteQuery").prop("disabled",!InquiryGeneralViewModel.Deletable);$("#divShowGrandTotals > span").addClass("selected");$("#chkShowGrandTotals").prop("checked",!0);$("a#inquiryExport").click(function(){i(this)});var e=document.getElementById("frmInquiryGeneral");e.onsubmit=function(){return!1}}function p(t){var u,i,f,r;if((t.preventDefault(),n.dataSource.length<=0)||(u=$(this).closest("tr"),i=$(this).closest("td")[0].cellIndex,i<0))return!1;InquiryGeneralViewModel.IsAdhocQuery&&(f=$(this).closest(n.lockedContent).length,i=i>-1&&f?i:i+1);var e=n.dataItem(u),o=n.columns[i],s=o.columnName,h=e[s];h&&(r=st(o,e),r&&sg.utls.iFrameHelper.openWindow("InqueryDetailPopup","",r,null,null,null))}function st(t,i){var o=t.drillDownUrl,tt=i[t.columnName],g="",f,r,c,s,l,y,a,p,b,k,u,e,d,nt;if(t.isDrillDown&&o){f=o.ControllerList;f&&f.length==1?r=f[0].Controller:(c=i[o.TypeField],s=o.SrceApplField?i[o.SrceApplField]:"",r=s?f.filter(function(n){return n.Type==c&&n.SrceAppl==s})[0]:f.filter(function(n){return n.Type==c})[0],r||(l=n.columns.filter(function(n){return n.field==o.TypeField}),l&&l.length>0&&(y=l[0],y.presentation&&(a=y.presentation.filter(function(n){return n.Text==c}),a&&a.length>0&&(p=a[0].Value,r=s?f.filter(function(n){return n.Type==p&&n.SrceAppl==s})[0]:f.filter(function(n){return n.Type==p})[0])))),r||(r=f[0]),r=r.Controller);var h=r.Parameters,w=h.length,v="";if(r.Controller==="InquiryGeneral"){if(v="?templateId="+h[0].Field,w>1){for(b="",u=1;u<w;u++)b+=i[h[u].Field]+",";v+="&id="+b.slice(0,-1)}}else for(k=InquiryGeneralViewModel.Ids,u=0;u<w;u++)e=h[u].Field,e.indexOf("{")==0&&e.indexOf("}")>1?(nt=e.substring(1,2),d=kendo.format(e,k?k[nt]:"")):d=i[e]||e,v+=kendo.format("{0}{1}={2}",u==0?"?":"&",h[u].Name,d);g=sg.utls.url.buildUrl(r.Area,r.Controller,r.Action)+"/"+v}return g}var w='#if({0} === null || {0} == ""){##}else{# #= kendo.toString(kendo.parseDate({0}), "d") #  #}#',s={eq:"=",neq:"!=",gt:">",gte:">=",lt:"<",lte:"<="},b=$.extend({},s,{Like:"Like",StartsWith:"Starts With",Contains:"Contains"}),n,t=10,h={},r=$("#btnPageSize10"),u=$("#btnPageSize20"),f=$("#btnPageSize30"),c=[],e=[],l="",a=!1,i="";return k(),{}}();